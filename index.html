<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Last Letter Hint</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    .wrap {
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 24px 12px;
      box-sizing: border-box;
    }
    .card {
      width: min(1000px, 100%);
      border: 1px solid #ddd;
      border-radius: 16px;
      padding: 18px;
      box-sizing: border-box;
    }
    h2 { margin: 0 0 12px; font-size: 20px; }
    .center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }
    input[type="text"] {
      width: min(520px, 100%);
      font-size: 22px;
      padding: 14px 16px;
      border: 1px solid #bbb;
      border-radius: 12px;
      outline: none;
      text-align: center;
    }
    button {
      font-size: 18px;
      padding: 12px 16px;
      border: 1px solid #bbb;
      border-radius: 12px;
      cursor: pointer;
      background: #f7f7f7;
    }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .status {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #eee;
      border-radius: 12px;
      background: #fafafa;
      box-sizing: border-box;
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 14px;
    }
    .col {
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 10px;
      background: #fff;
      box-sizing: border-box;
      min-height: 120px;
    }
    .col h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .words {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .word {
      font-size: 14px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      background: #fcfcfc;
    }
    .word:hover { background: #f0f0f0; }
    .tiny {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 6px;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      margin-top: 6px;
    }
    .controls label { font-size: 14px; }
    .controls input[type="number"]{
      width: 90px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #bbb;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Last Letter Hint (DWYL dictionary)</h2>

      <div class="center">
        <div class="row">
          <input type="file" id="fileInput" accept=".json,application/json" />
          <button id="clearUsedBtn" disabled>Reset used</button>
        </div>

        <input id="prefix" type="text" placeholder="Type required letters (e.g. a or th)" disabled />
        <div class="row">
          <button id="showBtn" disabled>Show matches</button>
          <button id="randomBtn" disabled>Random hint</button>
        </div>

        <div class="controls">
          <label>
            Max per length:
            <input id="maxPerLen" type="number" min="1" max="500" value="40" />
          </label>
          <label>
            Max total:
            <input id="maxTotal" type="number" min="50" max="5000" value="800" />
          </label>
        </div>

        <div class="status" id="status">Load the JSON word file first.</div>
      </div>

      <div id="results" class="grid"></div>
    </div>
  </div>

<script>
  // State
  let words = [];
  let used = new Set();

  // Fast index by first letter to avoid scanning everything each time
  let index = new Map(); // 'a' -> [word, word, ...]

  const elFile = document.getElementById("fileInput");
  const elPrefix = document.getElementById("prefix");
  const elStatus = document.getElementById("status");
  const elResults = document.getElementById("results");
  const elShow = document.getElementById("showBtn");
  const elRandom = document.getElementById("randomBtn");
  const elReset = document.getElementById("clearUsedBtn");
  const elMaxPerLen = document.getElementById("maxPerLen");
  const elMaxTotal = document.getElementById("maxTotal");

  function norm(s) {
    return (s || "").toLowerCase().replace(/[^a-z]/g, "");
  }

  function setEnabled(yes) {
    elPrefix.disabled = !yes;
    elShow.disabled = !yes;
    elRandom.disabled = !yes;
    elReset.disabled = !yes;
  }

  function buildIndex(wordArray) {
    index = new Map();
    for (const w of wordArray) {
      const first = w[0];
      if (!first) continue;
      if (!index.has(first)) index.set(first, []);
      index.get(first).push(w);
    }
  }

  function groupMatches(prefix) {
    const p = norm(prefix);
    if (!p) return { groups: new Map(), total: 0, prefix: "" };

    const bucket = index.get(p[0]) || [];
    const groups = new Map(); // len -> array of words
    let total = 0;

    const maxPerLen = Math.max(1, Math.min(500, parseInt(elMaxPerLen.value || "40", 10)));
    const maxTotal = Math.max(50, Math.min(5000, parseInt(elMaxTotal.value || "800", 10)));

    // Scan bucket and collect
    for (const w of bucket) {
      if (total >= maxTotal) break;

      // Skip used
      if (used.has(w)) continue;

      // Must start with prefix
      if (!w.startsWith(p)) continue;

      // IMPORTANT FIX: don't suggest the prefix itself (e.g. user typed "a" and "a" is a word)
      if (w === p) continue;

      const len = w.length;
      if (!groups.has(len)) groups.set(len, []);
      const arr = groups.get(len);
      if (arr.length >= maxPerLen) continue;

      arr.push(w);
      total++;
    }

    return { groups, total, prefix: p };
  }

  function clearResults() {
    elResults.innerHTML = "";
  }

  function render(groups, total, prefix) {
    clearResults();

    const lengths = Array.from(groups.keys()).sort((a,b) => a-b);

    if (!prefix) {
      elStatus.textContent = "Type required letters to see matches.";
      return;
    }

    if (total === 0) {
      elStatus.textContent = `No unused matches found for "${prefix}".`;
      return;
    }

    elStatus.textContent = `Found up to ${total} unused matches for "${prefix}". Click a word to copy + mark used.`;

    for (const len of lengths) {
      const col = document.createElement("div");
      col.className = "col";

      const title = document.createElement("h3");
      title.textContent = `${len} letters`;
      col.appendChild(title);

      const wrap = document.createElement("div");
      wrap.className = "words";

      for (const w of groups.get(len)) {
        const pill = document.createElement("span");
        pill.className = "word";
        pill.textContent = w;

        pill.addEventListener("click", async () => {
          // copy to clipboard
          try { await navigator.clipboard.writeText(w); } catch {}
          used.add(w);
          pill.remove(); // remove immediately from UI
          elStatus.textContent = `Copied + marked used: "${w}".`;
        });

        wrap.appendChild(pill);
      }

      col.appendChild(wrap);

      const note = document.createElement("div");
      note.className = "tiny";
      note.textContent = `Showing up to ${elMaxPerLen.value} words of this length.`;
      col.appendChild(note);

      elResults.appendChild(col);
    }
  }

  function showMatches() {
    const prefix = elPrefix.value;
    const { groups, total, prefix: p } = groupMatches(prefix);
    render(groups, total, p);
  }

  function randomHint() {
    const prefix = norm(elPrefix.value);
    if (!prefix) {
      elStatus.textContent = "Type required letters first.";
      return;
    }

    const bucket = index.get(prefix[0]) || [];
    const candidates = [];

    // gather a limited number of candidates (avoid huge memory)
    const maxTotal = Math.max(50, Math.min(5000, parseInt(elMaxTotal.value || "800", 10)));
    for (const w of bucket) {
      if (candidates.length >= maxTotal) break;
      if (used.has(w)) continue;
      if (!w.startsWith(prefix)) continue;
      if (w === prefix) continue; // same fix
      candidates.push(w);
    }

    if (candidates.length === 0) {
      elStatus.textContent = `No unused matches found for "${prefix}".`;
      return;
    }

    const pick = candidates[Math.floor(Math.random() * candidates.length)];
    used.add(pick);

    // copy it (best effort)
    navigator.clipboard?.writeText(pick).catch(() => {});
    elStatus.textContent = `Random hint (copied + marked used): "${pick}".`;
  }

  // Load DWYL JSON file
  elFile.addEventListener("change", async (evt) => {
    const file = evt.target.files[0];
    if (!file) return;

    setEnabled(false);
    clearResults();
    elStatus.textContent = "Loading and indexing words...";

    try {
      const text = await file.text();
      const obj = JSON.parse(text);

      // keys are words, value usually 1
      words = Object.keys(obj).map(norm).filter(Boolean);

      // Optional: remove extremely short 1-letter words (often not allowed)
      // words = words.filter(w => w.length >= 2);

      buildIndex(words);

      elStatus.textContent = `Loaded ${words.length.toLocaleString()} words. Type required letters and click “Show matches”.`;
      setEnabled(true);
      elPrefix.focus();
    } catch (e) {
      elStatus.textContent = "Failed to load JSON. Make sure you selected words_dictionary.json.";
      console.error(e);
      setEnabled(false);
    }
  });

  // Buttons
  elShow.addEventListener("click", showMatches);
  elRandom.addEventListener("click", randomHint);

  elReset.addEventListener("click", () => {
    used.clear();
    elStatus.textContent = "Reset used words.";
    showMatches();
  });

  // Enter key to show matches
  elPrefix.addEventListener("keydown", (e) => {
    if (e.key === "Enter") showMatches();
  });

  // Debounce typing: auto-refresh after a short pause
  let t = null;
  elPrefix.addEventListener("input", () => {
    if (t) clearTimeout(t);
    t = setTimeout(showMatches, 250);
  });

  // If user changes limits, refresh view
  elMaxPerLen.addEventListener("change", showMatches);
  elMaxTotal.addEventListener("change", showMatches);
</script>
</body>
</html>
